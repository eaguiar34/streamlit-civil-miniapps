import streamlit as st
from pathlib import Path
import fieldflow_core as core

st.set_page_config(page_title="Settings & Examples", page_icon="ðŸ§°", layout="wide")
core.render_sidebar("Settings & Examples")

st.title("Settings & Examples")

st.markdown("### Sample files (download)")
base = Path(__file__).resolve().parents[1] / "sample_data"

samples = [
    ("spec_sample.txt", "Spec sample (text)"),
    ("submittal_sample.txt", "Submittal sample (text)"),
    ("submittal_sample", "Submittal sample (text, no extension)"),
    ("schedule_sample.csv", "Schedule sample (CSV)"),
]

for fn, label in samples:
    fp = base / fn
    if fp.exists():
        st.download_button(
            label=f"Download: {label}",
            data=fp.read_bytes(),
            file_name=fn,
            mime="application/octet-stream",
            use_container_width=True,
        )

st.markdown("---")
st.markdown("### One-time setup for Microsoft (recommended)")
st.markdown(
    "If you're using **Microsoft 365 Excel (OAuth)**, click **Initialize OneDrive workbook** once. "
    "This creates (or finds) the workbook in your OneDrive and stores its ID in session storage so "
    "reruns don't keep trying to create a workbook."
)

# Show the init button too (same action as sidebar expander)
if st.button("Initialize OneDrive workbook", use_container_width=True):
    try:
        b = core.get_backend(core.BACKEND_MS_OAUTH)
        if hasattr(b, "init_workbook"):
            b.init_workbook()
        st.success("Workbook initialized.")
        st.rerun()
    except Exception as e:
        st.error(f"Init failed: {e}")

st.markdown("---")
st.markdown("### Troubleshooting")
st.markdown(
    "- If pages show `AttributeError: module 'fieldflow_core' has no attribute ...`, your deployed `fieldflow_core.py` is not the updated one.\n"
    "- Make sure your GitHub repo contains **fieldflow_core.py** at the repo root, and the `pages/` folder contains these page files.\n"
    "- In Streamlit Cloud, **Manage app â†’ Reboot app** after pushing the latest commit."
)
